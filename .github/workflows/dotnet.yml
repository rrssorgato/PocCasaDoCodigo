name: .NET

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore -fl1 "/flp1:logFile=errors_build.txt;errorsonly" -fl2 "/flp2:logFile=warnings_build.txt;warningsonly"
    - name: Get Output Build
      run: | 
        ERROS_BUILD=$(cat errors_build.txt)
        ERROS_BUILD="${ERROS_BUILD//'%'/'%25'}"
        ERROS_BUILD="${ERROS_BUILD//$'\n'/'%0A'}"
        ERROS_BUILD="${ERROS_BUILD//$'\r'/'%0D'}"
        
        WARNINGS_BUILD=$(cat warnings_build.txt)
        WARNINGS_BUILD="${WARNINGS_BUILD//'%'/'%25'}"
        WARNINGS_BUILD="${WARNINGS_BUILD//$'\n'/'%0A'}"
        WARNINGS_BUILD="${WARNINGS_BUILD//$'\r'/'%0D'}"
  
        echo "::set-output name=ErrBuild::$ERROS_BUILD"
        echo "::set-output name=WarnBuild::$WARNINGS_BUILD"
      id: build_step
    
    - name: Test
      run: dotnet test --no-build 2> test_erros.txt | egrep 'Failed!|Passed!' > test_result.txt
      
    - name: Get Output Test
      run: |
        ERRORS_TEST=$(cat test_erros.txt)
        ERRORS_TEST="${ERRORS_TEST//'%'/'%25'}"
        ERRORS_TEST="${ERRORS_TEST//$'\n'/'%0A'}"
        ERRORS_TEST="${ERRORS_TEST//$'\r'/'%0D'}"
        
        RESULT_TESTS=$(cat test_result.txt)
        RESULT_TESTS="${RESULT_TESTS//'%'/'%25'}"
        RESULT_TESTS="${RESULT_TESTS//$'\n'/'%0A'}"
        RESULT_TESTS="${RESULT_TESTS//$'\r'/'%0D'}"
        
        echo "::set-output name=ErrTest::$ERRORS_TEST"
        echo "::set-output name=ResultTest::$RESULT_TESTS"
      id: test_step  
    
    - name: Send Build Result
      uses: fjogeleit/http-request-action@v1
      with:
        url: "https://pocstatic-api.herokuapp.com/StaticCode/build"
        method: "POST"
        data: '{ "errors": "${{ steps.build_step.outputs.ErrBuild }}", "warnings": "${{ steps.build_step.outputs.WarnBuild }}" }'
    
    - name: Send Test Result
      uses: fjogeleit/http-request-action@v1
      with:
        url: "https://pocstatic-api.herokuapp.com/StaticCode/Test"
        method: "POST"
        data: '{ "errors": "${{ steps.test_step.outputs.ErrTest }}", "result": "${{ steps.test_step.outputs.ResultTest }}" }'
